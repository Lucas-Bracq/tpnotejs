<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TpNoté JS</title>
    <link type="text/css" rel="stylesheet" href="style.css">
    <script src="biblio.js"></script>

</head>

<body bgcolor="#afffff">
    <div id="main">
        <div id="identification">
            <input type="text" placeholder="Nom" value="Grosso">
            <input type="text" placeholder="Prénom" value="Roland"><br>
            <input type="text" placeholder="Adresse" value="2 Rue Bayard" size="46px"><br>
            <input type="text" placeholder="CP" value="05000">
            <input type="text" placeholder="ville" value="Gap"><br>
            <input type="text" placeholder="Téléphone" value="0783313081">
            <input type="text" placeholder="Email" value="jksqkas@gmail.com">
        </div>

        <div id="produits">
            <table>
                <thead>
                <tr>
                    <th>Reference</th>
                    <th>Prix</th>
                    <th>Quantité</th>
                </tr>
                </thead>
                <tbody id="tbod1">

                </tbody>
            </table>
            <input type="submit" value="Ajouter produit" id="addRow" onclick="expand()">

        </div>

        <div id="montant">
            <input type="text" name="qt" id="mt" placeholder="Montant" size="5"    readonly>
        </div>
    </div>
</body>
<script>
    //tableau contenant les produits
    var tabProduits = [
        {'reference': 'pc', 'prix':1000},
        {'reference':'imprimante', 'prix':80},
        {'reference':'repeteur', 'prix':30}
    ];

    //fonction permettant de pouvoir ajouter plusieurs produits dans une commande

    //Déclaration des tableaux qui contiendront les ids des différents id
    let tabIdListe = [];
    let tabIdAdd = [];
    let tabIdSub = [];
    let tabIdPrix = [];
    let tabIdQt = [];
    let tabIdDisp = [];
    let n = 1;


    function commande(){


        let idListe = "liste" + n;
        let idAdd = "add" + n;
        let idSub = "sub" + n;
        let idPrix = "prix" + n;
        let idQt = 'qt' + n;
        let idDisp = 'disp' + n;



        tabIdAdd.push(idAdd);
        tabIdQt.push(idQt);
        tabIdSub.push(idSub);
        tabIdListe.push(idListe);
        tabIdPrix.push(idPrix);
        tabIdDisp.push(idDisp);

        //si on appuie sur ajouter un produit ou, si le tableau contenant la commande est vide on ajoute une ligne de choix de produit
        if ($('tbod1').children.length == 0){

            row = '<tr>' +
                '<td><select name="liste" id='+ idListe + ' >' +
                '            </select></td>' +
                '<td> <input type="text" name="prix" \tid='+ idPrix + ' placeholder="Prix"\tsize="6"    readonly></td>' +
                '<td> <input type="text" name="qt" \tid='+ idQt + ' placeholder="Quantité"\tsize="5"    readonly></td>' +
                '<td>' +
                '<input type="button" id = '+ idAdd + ' value = "+" >' +
                '<input type="button" id =' + idSub + ' value = "-" >' +
                '</td>'
            '</tr>'
            $('tbod1').innerHTML += row;
            init(idListe, idAdd, idSub, idQt, idPrix, idDisp);
        }
    }

    function expand() {
            //création dinamique d'id afin de pouvoir initialiser dynamiquement le select, et les différents champs
            n+=1;
            idListe = "liste" + n;
            idAdd = "add" + n;
            idSub = "sub" + n;
            idPrix = "prix" + n;
            idQt = 'qt' + n;
            idDisp = 'disp' + n;

            tabIdAdd.push(idAdd);
            tabIdQt.push(idQt);
            tabIdSub.push(idSub);
            tabIdListe.push(idListe);
            tabIdPrix.push(idPrix);
            tabIdDisp.push(idDisp);

            $('tbod1').innerHTML += '<tr>' +
                '<td><select name="liste" id='+ idListe + ' >' +
                '            </select></td>' +
                '<td> <input type="text" name="prix" \tid='+ idPrix + ' placeholder="Prix"\tsize="6"    readonly></td>' +
                '<td> <input type="text" name="qt" \tid='+ idQt + ' placeholder="Quantité"\tsize="5"    readonly></td>' +
                '<td>' +
                '<input type="button" id = '+ idAdd + ' value = "+" >' +
                '<input type="button" id =' + idSub + ' value = "-" >' +
                '</td>' +
            '</tr>';
        init(idListe, idAdd, idSub, idQt, idPrix, idDisp);
    }

//////////////////////////////////
    function verifForm(idForm) {
        let form = document.getElementById(idForm).children;
        for (let i = 0; i < form.length; i++) {
            if (form[i].type == 'text' || form[i].type == 'email') {
                if (form[i].validity.valid == false) {
                    alert('Une ou plusieurs valeurs sont fausses');
                }
            }
        }
    }

    //fonction de remise à zéro
    function raz(id){
        document.getElementById(id).value = null;
    }


    /* fonction permettant d'afficher le produit n à l'ecran */

    function display(n, idPrix, idQt){
        $(idPrix).value	=	tabProduits[n].prix;
        $(idQt).value   =	"";
        $("mt").value	=	"";
    }

    /* fonction permettant de recalculer le montant */

    function calculate(){
        let total = 0;
        for (let i = 0; i<$('tbod1').children.length;i++ ){
             total += $(tabIdQt[i]).value*$(tabIdPrix[i]).value;
        }
        $("mt").value=total;
    }

    /* affichage du contenu du select */

    function init(idListe, idAdd, idSub, idQt, idPrix, idDisp){
        console.log(idDisp);
        var ch ='<option selected id=' + idDisp + '>Sélectionnez vos produits </option>';   // chaine contenant les options du select
        for (var i= 0;i<tabProduits.length;i++){
            ch+= `<option>${tabProduits[i].reference}</option>`;
        }
        $(idListe).innerHTML = ch;                            // affichage des options de la liste déroulante
        // ATTENTION ne jamais modifier la propiété innerHTML avec une information saisie par l'internaute
        listeners();
    }

    /* mise en place des écouteurs utilisation des tableaux stockants les id afin de pouvoir utiliser un nombre illimité de produits*/
    function listeners(){
        for (let i = 0; i<$('tbod1').children.length;i++ ){
        $(tabIdListe[i]).onclick  = $(tabIdDisp[i]).style.display = 'none';
        $(tabIdListe[i]).onchange  = function(){display(this.selectedIndex-1, tabIdPrix[i], tabIdQt[i]);}
        $(tabIdAdd[i]).onclick     = function(){if ($(tabIdListe[i]).value!='')
        {$(tabIdQt[i]).value++;calculate(tabIdPrix[i],tabIdQt[i]);}}
        $(tabIdSub[i]).onclick     = function(){if ($(tabIdQt[i]).value>0)
        {$(tabIdQt[i]).value--;calculate(tabIdPrix[i],tabIdQt[i]);}}
        }
    }


    onload=commande();
</script>
</html >